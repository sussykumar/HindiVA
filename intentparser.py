import re
from rapidfuzz import process, fuzz

# ==========================================
# TIER 0: THE TITANIUM DEVANAGARI TAXONOMY
# Synthesized from native Hindi and Hinglish NLU datasets
# ==========================================
COMMAND_REGISTRY = {
    # --- Home Automation ---
    "LIGHT_ON": [
        "à¤¬à¤¤à¥à¤¤à¥€ à¤œà¤²à¤¾à¤“", "à¤²à¤¾à¤‡à¤Ÿ à¤‘à¤¨ à¤•à¤°à¥‹", "à¤¬à¤¤à¥à¤¤à¥€ à¤šà¤¾à¤²à¥‚ à¤•à¤°à¥‹", "à¤°à¥‹à¤¶à¤¨à¥€ à¤•à¤°à¥‹", 
        "à¤²à¤¾à¤‡à¤Ÿ à¤šà¤¾à¤²à¥‚ à¤•à¤°à¥‹", "à¤Ÿà¥à¤¯à¥‚à¤¬à¤²à¤¾à¤‡à¤Ÿ à¤œà¤²à¤¾ à¤¦à¥‹", "à¤²à¤¾à¤‡à¤Ÿ à¤œà¤²à¤¾ à¤¦à¥‹", "à¤¬à¤¤à¥à¤¤à¥€ à¤‘à¤¨ à¤•à¤° à¤¦à¥‹",
        "à¤²à¤¾à¤‡à¤Ÿ à¤–à¥‹à¤² à¤¦à¥‹", "à¤¬à¤¤à¥à¤¤à¥€ à¤–à¥‹à¤² à¤¦à¥‹", "à¤¬à¤²à¥à¤¬ à¤œà¤²à¤¾à¤“", "à¤°à¥‹à¤¶à¤¨à¥€ à¤•à¤° à¤¦à¥‹", "à¤²à¤¾à¤‡à¤Ÿà¥à¤¸ à¤‘à¤¨",
        "à¤²à¤¾à¤‡à¤Ÿ à¤‘à¤¨ à¤•à¤°", "à¤¬à¤¤à¥à¤¤à¥€ à¤œà¤²à¤¾ à¤¦à¥‡", "à¤¬à¤²à¥à¤¬ à¤‘à¤¨ à¤•à¤°", "à¤²à¤¾à¤‡à¤Ÿ à¤œà¤²à¤¾à¤¨à¤¾", "à¤…à¤‚à¤§à¥‡à¤°à¤¾ à¤¦à¥‚à¤° à¤•à¤°à¥‹"
    ],
    "LIGHT_OFF": [
        "à¤¬à¤¤à¥à¤¤à¥€ à¤¬à¥à¤à¤¾à¤“", "à¤²à¤¾à¤‡à¤Ÿ à¤‘à¤« à¤•à¤°à¥‹", "à¤¬à¤¤à¥à¤¤à¥€ à¤¬à¤‚à¤¦ à¤•à¤°à¥‹", "à¤…à¤‚à¤§à¥‡à¤°à¤¾ à¤•à¤°à¥‹", 
        "à¤²à¤¾à¤‡à¤Ÿ à¤¬à¤‚à¤¦ à¤•à¤° à¤¦à¥‹", "à¤¸à¤¬ à¤¬à¤‚à¤¦ à¤•à¤°à¥‹", "à¤¬à¤¤à¥à¤¤à¥€ à¤‘à¤« à¤•à¤° à¤¦à¥‹", "à¤²à¤¾à¤‡à¤Ÿ à¤¬à¥à¤à¤¾ à¤¦à¥‹",
        "à¤¬à¤²à¥à¤¬ à¤¬à¤‚à¤¦ à¤•à¤°à¥‹", "à¤¬à¤¤à¥à¤¤à¤¿à¤¯à¤¾à¤‚ à¤¬à¥à¤à¤¾ à¤¦à¥‹", "à¤²à¤¾à¤‡à¤Ÿà¥à¤¸ à¤‘à¤«", "à¤²à¤¾à¤‡à¤Ÿ à¤‘à¤« à¤•à¤° à¤¦à¥‡",
        "à¤¬à¤¤à¥à¤¤à¥€ à¤¬à¥à¤à¤¾ à¤¦à¥‡", "à¤²à¤¾à¤‡à¤Ÿ à¤¬à¤‚à¤¦ à¤•à¤°", "à¤¬à¤¤à¥à¤¤à¥€ à¤‘à¤« à¤•à¤°à¤¨à¤¾", "à¤¬à¤²à¥à¤¬ à¤¬à¥à¤à¤¾à¤“"
    ],
    "FAN_ON": [
        "à¤ªà¤‚à¤–à¤¾ à¤šà¤²à¤¾à¤“", "à¤«à¥ˆà¤¨ à¤‘à¤¨ à¤•à¤°à¥‹", "à¤ªà¤‚à¤–à¤¾ à¤šà¤¾à¤²à¥‚ à¤•à¤°à¥‹", "à¤«à¥ˆà¤¨ à¤šà¤²à¤¾ à¤¦à¥‹", 
        "à¤ªà¤‚à¤–à¤¾ à¤‘à¤¨ à¤•à¤° do", "à¤ªà¤‚à¤–à¤¾ à¤–à¥‹à¤² à¤¦à¥‹", "à¤«à¥ˆà¤¨ à¤šà¤¾à¤²à¥‚ à¤•à¤° à¤¦à¥‹", "à¤¹à¤µà¤¾ à¤šà¤²à¤¾à¤“",
        "à¤ªà¤‚à¤–à¤¾ à¤šà¤²à¤¾ à¤¦à¥‡", "à¤«à¥ˆà¤¨ à¤‘à¤¨ à¤•à¤° à¤¦à¥‡", "à¤ªà¤‚à¤–à¤¾ à¤‘à¤¨ à¤•à¤°", "à¤«à¥ˆà¤¨ à¤šà¤²à¤¾à¤¨à¤¾"
    ],
    "FAN_OFF": [
        "à¤ªà¤‚à¤–à¤¾ à¤¬à¤‚à¤¦ à¤•à¤°à¥‹", "à¤«à¥ˆà¤¨ à¤‘à¤« à¤•à¤°à¥‹", "à¤ªà¤‚à¤–à¤¾ à¤°à¥‹à¤• à¤¦à¥‹", "à¤«à¥ˆà¤¨ à¤¬à¤‚à¤¦ à¤•à¤° à¤¦à¥‹", 
        "à¤ªà¤‚à¤–à¤¾ à¤‘à¤« à¤•à¤° à¤¦à¥‹", "à¤ªà¤‚à¤–à¤¾ à¤¬à¥à¤à¤¾ à¤¦à¥‹", "à¤ªà¤‚à¤–à¤¾ à¤¬à¤‚à¤¦ à¤•à¤° à¤¦à¥‡", "à¤«à¥ˆà¤¨ à¤‘à¤« à¤•à¤°",
        "à¤ªà¤‚à¤–à¤¾ à¤°à¥‹à¤• à¤¦à¥‡", "à¤«à¥ˆà¤¨ à¤¬à¤‚à¤¦ à¤•à¤°à¤¨à¤¾"
    ],
    "AC_ON": [
        "à¤à¤¸à¥€ à¤‘à¤¨ à¤•à¤°à¥‹", "à¤à¤¸à¥€ à¤šà¤²à¤¾ à¤¦à¥‹", "à¤à¤¸à¥€ à¤šà¤¾à¤²à¥‚ à¤•à¤°à¥‹", "à¤µà¤¾à¤¤à¤¾à¤¨à¥à¤•à¥‚à¤²à¤• à¤šà¤²à¤¾à¤“", 
        "à¤à¤¸à¥€ à¤‘à¤¨ à¤•à¤° à¤¦à¥‹", "à¤•à¥‚à¤²à¤¿à¤‚à¤— à¤•à¤°à¥‹", "à¤à¤¸à¥€ à¤šà¤²à¤¾ à¤¦à¥‡", "à¤à¤¸à¥€ à¤‘à¤¨ à¤•à¤°"
    ],
    
    # --- Time, Date & Weather ---
    "TIME_ASK": [
        "à¤¸à¤®à¤¯ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ", "à¤Ÿà¤¾à¤‡à¤® à¤¬à¤¤à¤¾à¤“", "à¤•à¤¿à¤¤à¤¨à¥‡ à¤¬à¤œà¥‡ à¤¹à¥ˆà¤‚", "à¤Ÿà¤¾à¤‡à¤® à¤•à¥à¤¯à¤¾ à¤¹à¥à¤†", 
        "à¤˜à¤¡à¤¼à¥€ à¤®à¥‡à¤‚ à¤•à¥à¤¯à¤¾ à¤Ÿà¤¾à¤‡à¤® à¤¹à¥ˆ", "à¤…à¤­à¥€ à¤•à¥à¤¯à¤¾ à¤¬à¤œà¤¾ à¤¹à¥ˆ", "à¤•à¥à¤¯à¤¾ à¤¸à¤®à¤¯ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ", 
        "à¤…à¤­à¥€ à¤Ÿà¤¾à¤‡à¤® à¤•à¥à¤¯à¤¾ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ", "à¤µà¤•à¥à¤¤ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ", "à¤•à¤¿à¤¤à¤¨à¤¾ à¤¬à¤œà¤¾ à¤¹à¥ˆ", "à¤Ÿà¤¾à¤‡à¤® à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ"
    ],
    "DATE_ASK": [
        "à¤†à¤œ à¤•à¥à¤¯à¤¾ à¤¤à¤¾à¤°à¥€à¤– à¤¹à¥ˆ", "à¤†à¤œ à¤•à¥€ à¤¡à¥‡à¤Ÿ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ", "à¤†à¤œ à¤•à¥Œà¤¨ à¤¸à¥€ à¤¤à¤¾à¤°à¥€à¤– à¤¹à¥ˆ",
        "à¤†à¤œ à¤•à¤¿à¤¤à¤¨à¥€ à¤¤à¤¾à¤°à¥€à¤– à¤¹à¥ˆ", "à¤†à¤œ à¤•à¤¾ à¤¦à¤¿à¤¨à¤¾à¤‚à¤• à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ", "à¤¤à¤¾à¤°à¥€à¤– à¤¬à¤¤à¤¾à¤“", "à¤¡à¥‡à¤Ÿ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ"
    ],
    "DAY_ASK": [
        "à¤†à¤œ à¤•à¥Œà¤¨ à¤¸à¤¾ à¤¦à¤¿à¤¨ à¤¹à¥ˆ", "à¤†à¤œ à¤•à¥Œà¤¨ à¤¸à¤¾ à¤¡à¥‡ à¤¹à¥ˆ", "à¤†à¤œ à¤•à¥à¤¯à¤¾ à¤¦à¤¿à¤¨ à¤¹à¥ˆ", 
        "à¤†à¤œ à¤•à¥Œà¤¨ à¤µà¤¾à¤° à¤¹à¥ˆ", "à¤¦à¤¿à¤¨ à¤¬à¤¤à¤¾à¤“"
    ],
    "WEATHER_ASK": [
        "à¤®à¥Œà¤¸à¤® à¤•à¥ˆà¤¸à¤¾ à¤¹à¥ˆ", "à¤†à¤œ à¤•à¤¾ à¤®à¥Œà¤¸à¤® à¤•à¥ˆà¤¸à¤¾ à¤¹à¥ˆ", "à¤†à¤œ à¤µà¥‡à¤¦à¤° à¤•à¥ˆà¤¸à¤¾ à¤¹à¥ˆ", 
        "à¤®à¥Œà¤¸à¤® à¤•à¤¾ à¤¹à¤¾à¤² à¤¬à¤¤à¤¾à¤“", "à¤¬à¤¾à¤¹à¤° à¤•à¤¾ à¤®à¥Œà¤¸à¤® à¤•à¥ˆà¤¸à¤¾ à¤¹à¥ˆ", "à¤•à¥à¤¯à¤¾ à¤†à¤œ à¤®à¥Œà¤¸à¤® à¤¸à¤¾à¤« à¤¹à¥ˆ",
        "à¤µà¥‡à¤¦à¤° à¤¬à¤¤à¤¾à¤“", "à¤¬à¤¾à¤¹à¤° à¤•à¥ˆà¤¸à¤¾ à¤®à¥Œà¤¸à¤® à¤¹à¥ˆ"
    ],
    "TEMP_ASK": [
        "à¤¤à¤¾à¤ªà¤®à¤¾à¤¨ à¤¬à¤¤à¤¾à¤“", "à¤¬à¤¾à¤¹à¤° à¤¤à¤¾à¤ªà¤®à¤¾à¤¨ à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ", "à¤°à¥‚à¤® à¤Ÿà¥‡à¤‚à¤ªà¤°à¥‡à¤šà¤° à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ", 
        "à¤†à¤œ à¤•à¤¿à¤¤à¤¨à¥€ à¤—à¤°à¥à¤®à¥€ à¤¹à¥ˆ", "à¤Ÿà¥‡à¤‚à¤ªà¤°à¥‡à¤šà¤° à¤¬à¤¤à¤¾à¤“", "à¤•à¤¿à¤¤à¤¨à¤¾ à¤¤à¤¾à¤ªà¤®à¤¾à¤¨ à¤¹à¥ˆ"
    ],
    "RAIN_ASK": [
        "à¤†à¤œ à¤•à¥€ à¤¬à¤¾à¤°à¤¿à¤¶", "à¤•à¥à¤¯à¤¾ à¤†à¤œ à¤¬à¤¾à¤°à¤¿à¤¶ à¤¹à¥‹à¤—à¥€", "à¤°à¥‡à¤¨ à¤•à¥‡ à¤šà¤¾à¤‚à¤¸à¥‡à¤¸ à¤¹à¥ˆà¤‚ à¤•à¥à¤¯à¤¾", 
        "à¤•à¥à¤¯à¤¾ à¤¬à¤¾à¤°à¤¿à¤¶ à¤¹à¥‹à¤¨à¥‡ à¤µà¤¾à¤²à¥€ à¤¹à¥ˆ", "à¤¬à¤¾à¤°à¤¿à¤¶ à¤¹à¥‹à¤—à¥€ à¤•à¥à¤¯à¤¾", "à¤ªà¤¾à¤¨à¥€ à¤¬à¤°à¤¸à¥‡à¤—à¤¾ à¤•à¥à¤¯à¤¾"
    ],

    # --- Reminders, Alarms & Media ---
    "ALARM_SET": [
        "à¤…à¤²à¤¾à¤°à¥à¤® à¤²à¤—à¤¾à¤“", "à¤…à¤²à¤¾à¤°à¥à¤® à¤¸à¥‡à¤Ÿ à¤•à¤°à¥‹", "à¤®à¥à¤à¥‡ à¤œà¤—à¤¾ à¤¦à¥‡à¤¨à¤¾", "à¤…à¤²à¤¾à¤°à¥à¤® à¤²à¤—à¤¾ à¤¦à¥‹", 
        "à¤¸à¥à¤¬à¤¹ à¤‰à¤ à¤¾ à¤¦à¥‡à¤¨à¤¾", "à¤µà¥‡à¤• à¤…à¤ª à¤…à¤²à¤¾à¤°à¥à¤®", "à¤…à¤²à¤¾à¤°à¥à¤® à¤šà¤¾à¤²à¥‚ à¤•à¤°à¥‹", "à¤…à¤²à¤¾à¤°à¥à¤® à¤²à¤—à¤¾ à¤¦à¥‡",
        "à¤…à¤²à¤¾à¤°à¥à¤® à¤¸à¥‡à¤Ÿ à¤•à¤° à¤¦à¥‡"
    ],
    "REMINDER_SET": [
        "à¤¯à¤¾à¤¦ à¤¦à¤¿à¤²à¤¾à¤¨à¤¾", "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¸à¥‡à¤Ÿ à¤•à¤°à¥‹", "à¤®à¥à¤à¥‡ à¤¯à¤¾à¤¦ à¤¦à¤¿à¤²à¤¾à¤“", "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤²à¤—à¤¾à¤“", 
        "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡ à¤®à¥€", "à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤° à¤¸à¥‡à¤Ÿ à¤•à¤° à¤¦à¥‹", "à¤•à¤² à¤®à¥€à¤Ÿà¤¿à¤‚à¤— à¤¯à¤¾à¤¦ à¤¦à¤¿à¤²à¤¾à¤¨à¤¾", 
        "à¤ªà¤°à¤¸à¥‹à¤‚ à¤µà¥ˆà¤•à¥à¤¸à¥€à¤¨à¥‡à¤¶à¤¨ à¤•à¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°", "à¤¬à¤°à¥à¤¥à¤¡à¥‡ à¤¯à¤¾à¤¦ à¤¦à¤¿à¤²à¤¾à¤¨à¤¾", "à¤¦à¤µà¤¾à¤ˆ à¤•à¤¾ à¤°à¤¿à¤®à¤¾à¤‡à¤‚à¤¡à¤°"
    ],
    "ALARM_STOP": [
        "à¤…à¤²à¤¾à¤°à¥à¤® à¤¬à¤‚à¤¦ à¤•à¤°à¥‹", "à¤…à¤²à¤¾à¤°à¥à¤® à¤°à¥‹à¤• à¤¦à¥‹", "à¤¸à¥à¤Ÿà¥‰à¤ª à¤‡à¤Ÿ", "à¤…à¤²à¤¾à¤°à¥à¤® à¤‘à¤« à¤•à¤°à¥‹", 
        "à¤šà¥à¤ª à¤¹à¥‹ à¤œà¤¾à¤“", "à¤…à¤²à¤¾à¤°à¥à¤® à¤¬à¤‚à¤¦ à¤•à¤° à¤¦à¥‡", "à¤…à¤²à¤¾à¤°à¥à¤® à¤‘à¤« à¤•à¤°"
    ],
    "VOLUME_UP": [
        "à¤†à¤µà¤¾à¤œà¤¼ à¤¬à¤¢à¤¼à¤¾à¤“", "à¤µà¥‰à¤²à¥à¤¯à¥‚à¤® à¤¤à¥‡à¤œ à¤•à¤°à¥‹", "à¤†à¤µà¤¾à¤œà¤¼ à¤¤à¥‡à¤œ à¤•à¤°à¥‹", "à¤µà¥‰à¤²à¥à¤¯à¥‚à¤® à¤…à¤ª", 
        "à¤œà¥‹à¤° à¤¸à¥‡ à¤¬à¥‹à¤²à¥‹", "à¤†à¤µà¤¾à¤œà¤¼ à¤œà¥à¤¯à¤¾à¤¦à¤¾ à¤•à¤°à¥‹", "à¤¸à¤¾à¤‰à¤‚à¤¡ à¤¬à¤¢à¤¼à¤¾à¤“", "à¤µà¥‰à¤²à¥à¤¯à¥‚à¤® à¤«à¥à¤² à¤•à¤°à¥‹"
    ],
    "VOLUME_DOWN": [
        "à¤†à¤µà¤¾à¤œà¤¼ à¤•à¤® à¤•à¤°à¥‹", "à¤µà¥‰à¤²à¥à¤¯à¥‚à¤® à¤•à¤® à¤•à¤°à¥‹", "à¤§à¥€à¤®à¥‡ à¤¬à¥‹à¤²à¥‹", "à¤µà¥‰à¤²à¥à¤¯à¥‚à¤® à¤¡à¤¾à¤‰à¤¨", 
        "à¤†à¤µà¤¾à¤œà¤¼ à¤¹à¤²à¥à¤•à¥€ à¤•à¤°à¥‹", "à¤¸à¤¾à¤‰à¤‚à¤¡ à¤•à¤® à¤•à¤°à¥‹", "à¤†à¤µà¤¾à¤œà¤¼ à¤•à¤® à¤•à¤° à¤¦à¥‹"
    ]
}

# ==========================================
# TIER 1: TEXT NORMALIZATION
# ==========================================
def normalize_text(text):
    """Removes punctuation and normalizes Hindi text for cleaner fuzzy matching."""
    text = re.sub(r'[^\w\s\u0900-\u097F]', '', text)
    return text.lower().strip()

# ==========================================
# TIER 2: THE MULTI-INTENT SLICER
# ==========================================
def split_commands(text):
    """
    Slices a continuous sentence into multiple isolated commands.
    It hunts for Hindi conjunctions like 'à¤”à¤°' (and), 'à¤¤à¤¥à¤¾', or 'à¤«à¤¿à¤°'.
    """
    parts = re.split(r'\s+(à¤”à¤°|à¤¤à¤¥à¤¾|à¤«à¤¿à¤°|and)\s+', text)
    commands = [p.strip() for p in parts if p.strip() not in ['à¤”à¤°', 'à¤¤à¤¥à¤¾', 'à¤«à¤¿à¤°', 'and'] and p.strip()]
    return commands

# ==========================================
# TIER 3: THE FUZZY ENGINE
# ==========================================
def parse_multiple_intents(text):
    """
    Takes the sliced commands and maps each one to its correct intent with RapidFuzz.
    """
    normalized_text = normalize_text(text)
    command_phrases = split_commands(normalized_text)
    
    results = []
    
    for phrase in command_phrases:
        best_match = None
        highest_score = 0
        
        for intent, phrases in COMMAND_REGISTRY.items():
            match = process.extractOne(phrase, phrases, scorer=fuzz.token_set_ratio)
            if match:
                score = match[1]
                if score > highest_score:
                    highest_score = score
                    best_match = intent
                    
        if highest_score >= 60:  
            results.append({"intent": best_match, "confidence": round(highest_score, 2), "phrase": phrase})
        else:
            results.append({"intent": "UNKNOWN_COMMAND", "confidence": round(highest_score, 2), "phrase": phrase})
            
    return results

# ==========================================
# LOCAL TESTING BLOCK
# ==========================================
if __name__ == "__main__":
    print("ðŸ§  Advanced Multi-Intent Parser Initialized.\n")
    
    test_query = "à¤•à¤² à¤®à¥€à¤Ÿà¤¿à¤‚à¤— à¤¯à¤¾à¤¦ à¤¦à¤¿à¤²à¤¾à¤¨à¤¾ à¤”à¤° à¤ªà¤‚à¤–à¤¾ à¤¬à¤‚à¤¦ à¤•à¤° à¤¦à¥‹"
    print(f"ðŸ—£ï¸ Input: '{test_query}'")
    
    result = parse_multiple_intents(test_query)
    
    print("\nâœ… Extracted Intents:")
    for res in result:
        print(f" - Command: '{res['phrase']}' -> Intent: {res['intent']} (Confidence: {res['confidence']}%)")